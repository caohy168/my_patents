<html><head><title>全文文本(Fulltext)</title><meta http-equiv='Content-Type' content='text/html; charset=UTF-8'><style>div.fullText table {width: 100%;text-indent: 1px;} 
 div.fullText table td.header {font-weight: bold;text-align: center;font-family: '宋体';font-size: 16px;line-height:20px;color: #000000;padding: 5px;}div.fullText table td.content {padding: 1px;text-align: left;vertical-align: top;width: 100%;font-family: '宋体';font-size: 14px;line-height:20px;color: #000000;}</style></head><body><?xml version="1.0" encoding="UTF-8"?><div xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:siposeas="java:com.neusoft.sipo.sipopublicsearch.search.app.view.detailUtils.xsltParser.XsltSeasParser" xmlns:str="http://example.com/namespace" class="fullText"><table class="fullText"><tr><td id="claim_title" class="header">权利要求书</td></tr><tr><td class="content" id="claim_1">1、一种支持主从设备互换的移动存储器，包括接口和卡控制器，其特征在
      <br/>于，所述接口包括主从设备切换请求/应答复用信号线；所述卡控制器用于向所
      <br/>述主从设备切换请求/应答复用信号线发送主从设备切换请求，并接收来自所述
      <br/>主从设备切换请求/应答复用信号线的主从设备切换应答，获取对移动存储器总
      <br/>线的控制权。
      <br/>
				</td></tr><tr><td class="content" id="claim_2">2、根据权利要求1所述的移动存储器，其特征在于，所述卡控制器包
      <br/>括：
      <br/>
				</td></tr><tr><td class="content" id="claim_3">切换请求单元，用于通过所述主从设备切换请求/应答复用信号线向主
      <br/>机发出切换请求，然后把所述主从设备切换请求/应答复用信号线设置为输
      <br/>入状态；
      <br/>
				</td></tr><tr><td class="content" id="claim_4">切换应答处理单元，在所述切换请求单元发出切换请求后，接收到所述
      <br/>主从设备切换请求/应答复用信号线的切换响应信号，则通知命令信号处理
      <br/>单元移动存储器的总线处于可控制状态；
      <br/>
				</td></tr><tr><td class="content" id="claim_5">命令信号处理单元，当收到所述切换应答处理单元的移动存储器的总线
      <br/>处于可控制状态后，向移动存储器的接口的命令CMD信号线发送命令信号。
      <br/>
				</td></tr><tr><td class="content" id="claim_6">3、根据权利要求2所述的移动存储器，其特征在于，所述接口包括用
      <br/>于传输时钟信号的时钟信号线；
      <br/>
				</td></tr><tr><td class="content" id="claim_7">所述切换应答处理单元用于在所述切换请求单元发出切换请求的第二
      <br/>个时钟周期，接收到所述主从设备切换请求/应答复用信号线的切换响应信
      <br/>号，则通知命令信号处理单元移动存储器的总线处于可控制状态。
      <br/>
				</td></tr><tr><td class="content" id="claim_8">4、根据权利要求2所述的移动存储器，其特征在于，所述卡控制器进
      <br/>一步包括：
      <br/>
				</td></tr><tr><td class="content" id="claim_9">计时等待单元，用于在所述切换请求单元发出切换请求后，预定时间内
      <br/>没有收到切换响应信号，则将所述主从设备切换请求/应答复用信号线设置
      <br/>为输出状态。
      <br/>
					
				</td></tr><tr><td class="content" id="claim_10">5、根据权利要求1至4任一项所述的移动存储器，其特征在于，所述
      <br/>卡控制器进一步包括：
      <br/>
				</td></tr><tr><td class="content" id="claim_11">切换判断单元，用于通过所述主从设备切换请求/应答复用信号线接收
      <br/>切换请求信号，根据当前对移动存储器总线的使用情况判断是否进行主从设
      <br/>备切换；
      <br/>
				</td></tr><tr><td class="content" id="claim_12">主从切换单元，用于当所述切换判断单元的判断结果为进行主从设备切
      <br/>换后，通过所述主从设备切换请求/应答复用信号线向主机发送切换应答信
      <br/>号，并将所述主从设备切换请求/应答复用信号线设置为输入状态。
      <br/>
				</td></tr><tr><td class="content" id="claim_13">6、一种主从设备互换的方法，其特征在于，移动存储器与主机连接的
      <br/>接口包括主从设备切换请求/应答复用信号线，该方法包括如下步骤：
      <br/>
				</td></tr><tr><td class="content" id="claim_14">移动存储器的卡控制器通过所述主从设备切换请求/应答复用信号线向
      <br/>主机控制器发出切换请求，再将主从设备切换请求/应答复用信号线的引脚
      <br/>设置为输入状态；
      <br/>
				</td></tr><tr><td class="content" id="claim_15">主机控制器收到切换请求后，根据当前对总线的使用情况判断是否进行
      <br/>主从设备切换，若是，则将对应主从设备切换请求/应答复用信号线的引脚
      <br/>设置为输出状态，通过所述主从设备切换请求/应答复用信号线向所述卡控
      <br/>制器发送切换应答信号；
      <br/>
				</td></tr><tr><td class="content" id="claim_16">卡控制器收到切换应答信号后，执行对移动存储器总线的控制操作。
      <br/>
				</td></tr><tr><td class="content" id="claim_17">7、根据权利要求6所述的主从设备互换的方法，其特征在于，所述主
      <br/>机控制器收到切换请求后，根据当前对总线的使用情况判断是否进行主从设
      <br/>备切换，且判断结果为不进行主从设备切换，则进一步包括：
      <br/>
				</td></tr><tr><td class="content" id="claim_18">卡控制器等待预定时间后，未收到切换响应信号，则将对应所述主从设
      <br/>备切换请求/应答复用信号线的引脚设置为高电平输出。
      <br/>
				</td></tr><tr><td class="content" id="claim_19">8、根据权利要求6所述的主从设备互换的方法，其特征在于，所述移
      <br/>动存储器的卡控制器通过所述主从设备切换请求/应答复用信号线向主机控
      <br/>制器发出切换请求包括：
      <br/>
				</td></tr><tr><td class="content" id="claim_20">所述卡控制器对应所述主从设备切换请求/应答复用信号线的初始为输
      <br/>
					出高电平；所述卡控制器将所述主从设备切换请求/应答复用信号线设置为
      <br/>低电平，然后卡控制器将所述主从设备切换请求/应答复用信号线设置为输
      <br/>入状态。
      <br/>
				</td></tr><tr><td class="content" id="claim_21">9、根据权利要求8所述的主从设备互换的方法，其特征在于，所述主
      <br/>机控制器通过所述主从设备切换请求/应答复用信号线向所述卡控制器发送
      <br/>切换应答信号包括：
      <br/>
				</td></tr><tr><td class="content" id="claim_22">主机控制器对应所述主从设备切换请求/应答复用信号线的初始为输入
      <br/>状态；在收到切换请求后的第二个时钟周期，将所述主从设备切换请求/应
      <br/>答复用信号线的信号置为低电平一个时钟周期。
      <br/>
				</td></tr><tr><td class="content" id="claim_23">10、根据权利要求6至9任一项所述的主从设备互换的方法，其特征在
      <br/>于，所述卡控制器收到切换应答信号后，将对应主从设备切换请求/应答复
      <br/>用信号线的引脚设置为输入状态，并执行对移动存储器总线的控制操作之
      <br/>后，进一步包括：
      <br/>
				</td></tr><tr><td class="content" id="claim_24">主机控制器通过所述主从设备切换请求/应答复用信号线向移动存储器
      <br/>的卡控制器发出切换请求，再将对应主从设备切换请求/应答复用信号线的
      <br/>引脚设置为输入状态；
      <br/>
				</td></tr><tr><td class="content" id="claim_25">卡控制器收到切换请求后，根据当前对总线的使用情况判断是否进行主
      <br/>从设备切换，若是，则将对应主从设备切换请求/应答复用信号线的引脚设
      <br/>置为输出状态，通过所述主从设备切换请求/应答复用信号线向所述主机控
      <br/>制器发送切换应答信号；
      <br/>
				</td></tr><tr><td class="content" id="claim_26">主机控制器收到切换应答信号后，执行对移动存储器总线的控制操作。
      <br/>
					
				</td></tr></table></div><div xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:siposeas="java:com.neusoft.sipo.sipopublicsearch.search.app.view.detailUtils.xsltParser.XsltSeasParser" xmlns:str="http://example.com/namespace" class="fullText"><table><tr><td id="description_title" class="header">说明书</td></tr><tr><td class="content" id="description_invention_title">支持主从设备互换的移动存储器和主从设备互换方法
  </td></tr><tr><td class="content" id="description_1">技术领域
  </td></tr><tr><td class="content" id="description_2">本发明涉及移动存储技术领域，特别涉及一种支持主从设备接口互换的
    移动存储器和一种主从设备互换方法。
    
				</td></tr><tr><td class="content" id="description_3">背景技术
  </td></tr><tr><td class="content" id="description_4">移动存储器可以方便地与计算机或其它设备交换并存储数据，并且方便
    携带，日益成为人们生活和工作中不可或缺的IT产品。目前常见的移动存
    储器包括各种闪存卡、移动硬盘、U盘，还包括带有上述功能的其它数码产
    品，如数码伴侣等。为方便描述，以下将与移动存储器连接并交换数据的计
    算机或其它设备统称为主机(host)。
    
				</td></tr><tr><td class="content" id="description_5">图1为移动存储器的基本结构框图。如图1所示，移动存储器包括接口
    101、卡控制器102、寄存器103和存储器104。接口101为移动存储器规范
    所规定的物理接口，如安全数字记忆卡(Secure Digital Memory Card，SD)
    接口、多媒体存储卡(Multi-Media Card，MMC)接口或通用串行总线
    (universal serial bus，USB)接口等。移动存储器通过接口101与外部通讯。
    卡控制器102主要完成协议解析，存储器104的访问与管理；存储器104为
    存储数据的物理介质，可以为闪存(FLASH)、硬盘或其它存储介质，用于
    存储来自接口101的数据，或将所存储的数据提供给接口101。寄存器103
    中存储着认证号、存储器104中的地址信息、总线驱动状态、操作环境、版
    本信息等内容，通过内部总线与卡控制器102交互。数据总线在各存储卡协
    议(SD协议、MMC协议等)中已有规定这里不再叙述；存储区访问总线根
    据存储介质的不同而不同，如存储介质为FLASH，则存储区访问总线即指
    FLASH的操作总线。以上所述数据总线、内部总线以及存储区域访问总线
    
					总称为移动存储器总线。
    
				</td></tr><tr><td class="content" id="description_6">以常见SD卡为例，对现有技术中的主机和移动存储器的连接关系进行
    介绍。图2为现有技术中的SD卡与主机的连接关系示意图。其中，时钟信
    号(CLK)线传输主机的时钟信号，同时也作为SD卡总线的时钟信号；Vdd
    为电源线，Vss为电源地线，Vdd和Vss的作用是对SD卡进行供电。
    DATA0-DATAn为数据线，用于传输数据，数目为n+1根，n的数值取决于
    SD卡总线的数据宽度，对于目前常见的SD卡来说，n＝3。CMD是控制命
    令信号线，用于传输命令(Command)和响应(Response)。其中，命令是
    从主机传输给SD卡，用于开始某种特定的操作，如数据的存储、删除等；
    响应是从SD卡传输给主机，作为SD卡所收到的命令的应答。命令和响应
    都是串行传输的。其它类型的移动存储器与主机的连接关系与此类似，不再
    一一赘述。
    
				</td></tr><tr><td class="content" id="description_7">从以上移动存储器与主机的连接关系中可以看出，现有技术中，移动存
    储器作为从设备，主机为主设备，移动存储器的总线由主设备上的主机控制
    器控制。移动存储器对总线没有控制权，这使得移动存储器总线的使用效率
    不高，并在一定程度上限制了访问移动存储器接口总线的灵活性。
    
				</td></tr><tr><td class="content" id="description_8">发明内容
  </td></tr><tr><td class="content" id="description_9">有鉴于此，本发明的目的在于，提出一种支持主从设备接口互换的移动
    存储器以及主从设备互换的方法，可以使移动存储器获得对总线的控制权，
    提高移动存储器总线的使用效率。
    
				</td></tr><tr><td class="content" id="description_10">本发明实施例提出的一种支持主从设备互换的移动存储器，包括接口和卡
    控制器，所述接口包括主从设备切换请求/应答复用信号线；所述卡控制器用于
    向所述主从设备切换请求/应答复用信号线发送主从设备切换请求，并接收来自
    所述主从设备切换请求/应答复用信号线的主从设备切换应答，获取对移动存储
    器总线的控制权。
    
				</td></tr><tr><td class="content" id="description_11">本发明实施例还提出一种主从设备互换的方法，移动存储器与主机连接
    的接口包括主从设备切换请求/应答复用信号线，该方法包括如下步骤：
    
				</td></tr><tr><td class="content" id="description_12">移动存储器的卡控制器通过所述主从设备切换请求/应答复用信号线向
    主机控制器发出切换请求，再将主从设备切换请求/应答复用信号线的引脚
    设置为输入状态；
    
				</td></tr><tr><td class="content" id="description_13">主机控制器收到切换请求后，根据当前对总线的使用情况判断是否进行
    主从设备切换，若是，则将对应主从设备切换请求/应答复用信号线的引脚
    设置为输出状态，通过所述主从设备切换请求/应答复用信号线向所述卡控
    制器发送切换应答信号；
    
				</td></tr><tr><td class="content" id="description_14">卡控制器收到切换应答信号后，执行对移动存储器总线的控制操作。
    
				</td></tr><tr><td class="content" id="description_15">从以上技术方案可以看出，在移动存储器和主机之间的接口中包括主从
    设备切换请求/应答复用信号线，移动存储器通过主从设备切换请求/应答复
    用信号线可以向主机发起主从设备切换请求，并接收到来自主机的切换应答
    后，可以对总线进行控制操作。本发明方案可以使移动存储器获得对总线的
    控制权，提高移动存储器总线的使用效率。
    
				</td></tr><tr><td class="content" id="description_16">附图说明
  </td></tr><tr><td class="content" id="description_17">图1为移动存储器的基本结构示意图；
    
				</td></tr><tr><td class="content" id="description_18">图2为现有技术中的SD卡与主机的接口连接关系示意图；
    
				</td></tr><tr><td class="content" id="description_19">图3为本发明实施例中的SD卡与主机的接口连接关系示意图；
    
				</td></tr><tr><td class="content" id="description_20">图4为本发明实施例实现SD卡与主机进行主从设备互换的流程图；
    
				</td></tr><tr><td class="content" id="description_21">图5为本发明实施例另一种实现SD卡与主机进行主从设备互换的流程
    图。
    
				</td></tr><tr><td class="content" id="description_22">具体实施方式
  </td></tr><tr><td class="content" id="description_23">为使本发明的目的、技术方案和优点更加清楚，下面结合附图对本发明
    作进一步的详细阐述。
    
				</td></tr><tr><td class="content" id="description_24">本发明实施例对移动存储器的接口总线作如下改动：
    
				</td></tr><tr><td class="content" id="description_25">增加一条主从设备切换请求/应答复用信号线，其属性是输入输出IO属
    性。初始状态下，主机具有对移动存储器总线的控制权。移动存储器的卡控
    制器通过主从设备切换请求/应答复用信号线向主机发送主从设备切换请
    求，该切换请求由主机控制器接收。如果主机控制器同意进行主从设备的切
    换，则通过所述主从设备切换请求/应答复用信号线向移动存储器的卡控制
    器发送主从设备切换应答，卡控制器获得对移动存储器总线的控制权。
    
				</td></tr><tr><td class="content" id="description_26">图3为本发明实施例的SD卡与主机的连接关系示意图。与图2对比可
    以发现，图3中的SD卡和主机之间增加了一条主从设备切换请求/应答复用
    信号线，主机侧的主机控制器以及SD卡侧的卡控制器均可向所述主从设备
    切换请求/应答复用信号线发送主从设备切换请求或主从设备切换应答，或
    者接收来自所述主从设备切换请求/应答复用信号线的主从设备切换请求或
    主从设备切换应答。
    
				</td></tr><tr><td class="content" id="description_27">本发明实施例的主从设备互换过程如图4所示，初始状态为主机控制器
    控制总线，主从设备切换请求/应答信号由卡控制器驱动，即卡控制器对应
    主从设备切换请求/应答复用信号线的引脚为输出状态，主机控制器对应主
    从设备切换请求/应答复用信号线为输入状态。初始状态时，卡控制器控制
    对应主从设备切换请求/应答复用信号线的引脚为高电平输出，表示没有切
    换请求。包括如下步骤：
    
				</td></tr><tr><td class="content" id="description_28">步骤401：卡控制器需要控制总线时，通过把主从设备切换请求/应答复
    用信号线的输出置低电平向主机控制器发出切换请求，然后卡控制器对应主
    从设备切换请求/应答复用信号线转变为输入状态；
    
				</td></tr><tr><td class="content" id="description_29">步骤402：主机控制器收到切换请求后，根据当前对总线的使用情况判
    断是否同意切换，例如若当前正在执行某项主机和SD卡之间的操作，例如
    进行主机和SD卡之间的数据传输，则不同意切换；若当前总线处于空闲状
    态，则同意切换。若不同意切换，转至步骤404。若同意切换，则在接到切
    换请求后的第二个时钟周期，向主从设备切换请求/应答复用信号线输出切
    
					换应答信号。具体做法可以是在接到切换请求后的第二个时钟周期，将该信
    号线的输出信号置为低电平一个时钟周期，第一个时钟周期为隔离周期，用
    来隔离切换请求信号驱动源的切换。
    
				</td></tr><tr><td class="content" id="description_30">步骤403：卡控制器收到切换应答信号后，对应主从设备切换请求/应答
    复用信号线保持输入状态，执行对移动存储器总线的控制操作；主机控制器
    驱动主从设备切换请求/应答信号，主机控制器控制切换请求信号引脚为高
    电平输出。
    
				</td></tr><tr><td class="content" id="description_31">步骤404：卡控制器等待预定时间后，未收到切换响应信号，则恢复初
    始状态，即卡控制器对应主从设备切换请求/应答复用信号线的引脚为为高
    电平输出，而主机控制器对应主从设备切换请求/应答复用信号线为输入状
    态。
    
				</td></tr><tr><td class="content" id="description_32">上述流程中，将主从设备切换请求/应答复用信号线置为高电平输出表
    示无信号，置为低电平输出表示切换请求或切换应答信号，实际应用中也可
    作相反的规定，即主从设备切换请求/应答复用信号线置为低电平输出表示
    无信号，置为高电平输出表示切换请求或切换应答信号。
    
				</td></tr><tr><td class="content" id="description_33">经过上述流程实现主从设备切换后，卡控制器获得对总线的控制权，则
    SD卡成为主设备，而主机成为从设备。
    
				</td></tr><tr><td class="content" id="description_34">接着，SD卡和主机之间还可以再次发生主从设备互换过程，如图5所
    示，包括如下步骤：
    
				</td></tr><tr><td class="content" id="description_35">步骤501：主机控制器需要控制总线时，通过把主从设备切换请求/应答
    复用信号线的输出置为低电平向卡控制器发出切换请求，然后把主从设备切
    换请求/应答复用信号线的输出转变为输入状态；
    
				</td></tr><tr><td class="content" id="description_36">步骤502：卡控制器收到切换请求后，根据当前对总线的使用情况判断
    是否同意切换，例如若当前正在执行某项主机和SD卡之间的操作，例如进
    行主机和SD卡之间的数据传输，则不同意切换；若当前总线处于空闲状态，
    则同意切换。若不同意切换，转至步骤504。若同意切换，则在接到切换请
    求后的第二个时钟周期，向主从设备切换请求/应答复用信号线输出切换应
    
					答信号。具体做法可以是在接到切换请求后的第二个时钟周期，将该信号线
    的输出信号置为低电平一个时钟周期，第一个时钟周期为隔离周期，用来隔
    离切换请求信号驱动源的切换。
    
				</td></tr><tr><td class="content" id="description_37">步骤503：主机控制器收到切换应答信号后，对应主从设备切换请求/
    应答复用信号线的引脚保持为输入状态，执行对移动存储器总线的控制操
    作；卡控制器驱动主从设备切换请求/应答信号，卡控制器控制切换请求信
    号引脚为高电平输出。
    
				</td></tr><tr><td class="content" id="description_38">步骤504：主机控制器等待预定时间后，未收到切换响应信号，则恢复
    本次切换前的状态，即主机控制器控制切换请求信号引脚为高电平输出，而
    卡控制器对应主从设备切换请求/应答复用信号线为输入状态。
    
				</td></tr><tr><td class="content" id="description_39">以上实施例中，所述高电平、低电平仅是用于表述切换请求信号引脚处
    于某种特定状态，实际也可将上述高低电平互换，同样可以实现本发明实施
    例的方案。
    
				</td></tr><tr><td class="content" id="description_40">本发明另一实施例提出支持主从设备互换的移动存储器，该移动存储器的
    基本结构与现有的移动存储器类似，同样包括接口、卡控制器、寄存器和存储
    器。本发明实施例的移动存储器的接口相对于现有技术的移动存储器接口来说，
    增加了主从设备切换请求/应答复用信号线，其输入输出属性为输入/输出IO属
    性；所述卡控制器用于向所述主从设备切换请求/应答复用信号线发送主从设备
    切换请求，并接收来自所述主从设备切换请求/应答复用信号线的主从设备切换
    应答，获取对移动存储器总线的控制权。
    
				</td></tr><tr><td class="content" id="description_41">为实现主从设备切换，所述卡控制器需要增加如下单元：
    
				</td></tr><tr><td class="content" id="description_42">切换请求单元，用于通过所述主从设备切换请求/应答复用信号线向主
    机发出切换请求，然后把所述主从设备切换请求/应答复用信号线设置为输
    入状态；
    
				</td></tr><tr><td class="content" id="description_43">切换应答处理单元，在所述切换请求单元发出切换请求后，接收到所述
    主从设备切换请求/应答复用信号线的切换响应信号，则通知命令信号处理
    
					单元移动存储器的总线处于可控制状态；
    
				</td></tr><tr><td class="content" id="description_44">命令信号处理单元，当收到所述切换应答处理单元的移动存储器的总线
    处于可控制状态后，向移动存储器的接口的命令CMD信号线发送命令信号。
    
				</td></tr><tr><td class="content" id="description_45">所述接口包括用于传输时钟信号的时钟信号线；
    
				</td></tr><tr><td class="content" id="description_46">所述切换应答处理单元用于在所述切换请求单元发出切换请求的第二
    个时钟周期，接收到所述主从设备切换请求/应答复用信号线的切换响应信
    号，通知命令信号处理单元移动存储器的总线处于可控制状态。
    
				</td></tr><tr><td class="content" id="description_47">较佳地，所述卡控制器进一步包括：
    
				</td></tr><tr><td class="content" id="description_48">计时等待单元，用于在所述切换请求单元发出切换请求后，预定时间内
    没有收到切换响应信号，则将所述主从设备切换请求/应答复用信号线设置
    为输出状态。
    
				</td></tr><tr><td class="content" id="description_49">所述卡控制器进一步包括：
    
				</td></tr><tr><td class="content" id="description_50">切换判断单元，用于通过所述主从设备切换请求/应答复用信号线接收
    切换请求信号，根据当前对移动存储器总线的使用情况判断是否进行主从设
    备切换；
    
				</td></tr><tr><td class="content" id="description_51">主从切换单元，用于当所述切换判断单元的判断结果为进行主从设备切
    换后，通过所述主从设备切换请求/应答复用信号线向主机发送切换应答信
    号，并将所述主从设备切换请求/应答复用信号线设置为输入状态。
    
				</td></tr><tr><td class="content" id="description_52">以上实施例均以SD卡为例进行阐述，由于SD卡与其它类型的移动存
    储器的基本结构和功能都是类似的，本领域技术人员可以根据上述实施例，
    将本发明方案很容易地推广到其它类型移动存储器。
    
				</td></tr><tr><td class="content" id="description_53">本发明方案可以提高移动存储器主机接口总线的利用率，增强移动存储
    器访问主机接口总线的灵活性。
    
				</td></tr><tr><td class="content" id="description_54">以上所述仅为本发明的较佳实施例而已，并不用以限制本发明，凡在本
    发明的精神和原则之内所作的任何修改、等同替换和改进等，均应包含在本
    发明的保护范围之内。
    
				</td></tr></table></div></body></html>